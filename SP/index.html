<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>SINGELPLAYER | DATASCAPE</title>
    <style>
        canvas {
            width:100%;
            height:100%;
            position:fixed;
            top:0px;
            left:0px;
        }
    </style>
</head>
<body onresize="resize()" onkeydown="translateKeyDown(event)" onkeyup="translateKeyUp(event)" onload="resize()">
    <canvas id="canvas" onmousemove="mouse(event)" oncontextmenu="return false;"></canvas>
</body>
<script>
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    canvas.width= window.innerWidth;
    canvas.height = window.innerHeight;

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    ctx.scale(1,1)
</script>
<script src="../storage/js/player.js"></script>
<script src="../storage/js/block.js"></script>
<script src="../storage/js/item.js"></script>
<script src="../storage/js/collision.js"></script>
<script src="../storage/js/inventory.js"></script>
<script src="../storage/js/itemType.js"></script>
<script src="../storage/js/blockType.js"></script>

<script>
    var mouseX = 0;
    var mouseY = 0;
    function mouse(e) {
        mouseX = e.clientX;
        mouseY = e.clientY;
    }
    var mouseClicked = false;
    var mouseClicked2 = false;

    canvas.onmousedown = function(e) {
        if (e.which == 3) {
            mouseClicked2 = true;
            placeBlock();
        } else if (e.which = 1) {
        mouseClicked = true;
        }
    }

    canvas.onmouseup = function(e){
        if (e.which == 3) {
            mouseClicked2 = false;
        } else if (e.which = 1) {
        mouseClicked = false;
        }
    }

    var showCollision = false;

    var player = new Player(-64,-128,100,0.4,5,0.2,false,0,0)
    var playerCollision = new Collision(player.x,player.y,64,64);

    var itemTypes = new Array;
    var blockTypes = new Array;

    var blocks = new Array;

    var it_lithium_ore = new itemType("../storage/png/lithium_ore.png",["ore","block"],"Lithium ore");
    var it_gold_ore = new itemType("../storage/png/gold_ore.png", ["ore","block"],"Gold ore");
    var it_titanium_ore = new itemType("../storage/png/titanium_ore.png",["ore","block"],"Titanium ore");
    var it_copper_ore = new itemType("../storage/png/copper_ore.png", ["ore","block"], "Copper ore");
    
    var it_stone = new itemType("../storage/png/stone.png", ["block"], "Stone")
    var it_grass = new itemType("../storage/png/grass.png",["block"], "Grass");
    var it_dirt = new itemType("../storage/png/dirt.png",["block"], "Dirt");

    var it_container_empty = new itemType("../storage/png/container_empty.png", ["container","item"],"Empty container")
    var it_container_methane = new itemType("../storage/png/container_methane.png", ["container","full","item"],"Container of Methane")
    var it_container_water = new itemType("../storage/png/container_water.png", ["container","full","item"], "Container of Water");
    

    itemTypes.push(it_lithium_ore);
    itemTypes.push(it_gold_ore);
    itemTypes.push(it_titanium_ore);
    itemTypes.push(it_copper_ore);
    itemTypes.push(it_container_empty);
    itemTypes.push(it_container_methane);
    itemTypes.push(it_container_water);  
    itemTypes.push(it_stone);
    itemTypes.push(it_dirt);
    itemTypes.push(it_grass);

    
    var bt_lithium_ore = new blockType("../storage/png/lithium_ore.png", "Lithium ore", it_lithium_ore);
    var bt_gold_ore = new blockType("../storage/png/gold_ore.png", "Gold ore", it_gold_ore);
    var bt_titanium_ore = new blockType("../storage/png/titanium_ore.png", "Titanium ore", it_titanium_ore);
    var bt_copper_ore = new blockType("../storage/png/copper_ore.png", "Copper ore", it_copper_ore);

    var bt_stone = new blockType("../storage/png/stone.png", "Stone", it_stone);
    var bt_grass = new blockType("../storage/png/grass.png", "Grass", it_grass);
    var bt_dirt = new blockType("../storage/png/dirt.png", "Dirt", it_dirt);

    blockTypes.push(bt_grass);
    blockTypes.push(bt_dirt);
    blockTypes.push(bt_stone);
    blockTypes.push(bt_copper_ore);
    blockTypes.push(bt_titanium_ore);
    blockTypes.push(bt_lithium_ore);
    blockTypes.push(bt_gold_ore);

    var inventory = new Inventory(20,20,500,500,[]);
    for (i=0;i<itemTypes.length;i++) {
inventory.addItem(itemTypes[i],Infinity);
}

worldsize = 100;
line = 0;
//generate world
for (i=0;i<worldsize*worldsize;i++) {
    if (i%worldsize == 0) {
        line++;
    }
    n = i-worldsize*line;

    var typ = Math.floor(Math.pow(Math.random()*blockTypes.length, 0.1+line/(worldsize/2)))
    if (line == 1) {
        typ = 0
    } 
    if (line != 1 && typ == 0) {
        typ = 1;
    }

     if (typ > blockTypes.length-1) {
         console.log(typ);
         typ = blockTypes.length-1;
     }

    var block = new Block(n,line,blockTypes[typ]);
    blocks.push(block);
}

    var left = false;
    var right = false;
    var up = false;
    var down = false;

    function placeBlock() {
        if (mouseClicked2) {
            if (inventory.equipedItem != "none") {
                if (inventory.equipedItem.amount > 0) {
                    for (i=0;i<blockTypes.length;i++) {
                        if (blockTypes[i].item == inventory.equipedItem.type && inventory.equipedItem.amount > 0) {
                            // cursor to ingame position
                            x = Math.round((mouseX+player.x-canvas.width/2)/64)
                            y = Math.round((mouseY+player.y-canvas.height/2)/64)

                            for (o=0;o<blocks.length;o++) {
                                if (blocks[o].x == x && blocks[o].y == y) {
                                    return;
                                }
                            }
                                
                            block = new Block(x,y,blockTypes[i]);
                            blocks.push(block);
                            
                            inventory.removeItem(inventory.equipedItem,1);
                        }
                    }
                }
            }
        }
    }

    function translateKeyDown(e) {
        if (e.keyCode == 68) {
            right = true; 
        }
        if (e.keyCode == 65) {
            left = true;
        }
        if (e.keyCode == 87) {
            if (player.onGround == true) {
                playergx = Math.floor((player.x-32)/64);
                playergy = Math.floor((player.y-32)/64);
                    for (i=0;i<blocks.length;i++) {
                        if (blocks[i].y == playergy && blocks[i].x-1 == playergx) {
                            return;
                        }
                    }

                player.move(-6.5,true);
                player.onGround = false;
            }
        }
        if (e.keyCode == 83) {
            inventory.isOpen = !inventory.isOpen;
        }
        if (e.keyCode == 90) {
            if (blocks.length > 0) {
            blocks[blocks.length-1].destroy(inventory,false);
            }
        }
    }

    function translateKeyUp(e) {
        if (e.keyCode == 68) {
            right = false; 
        }
        if (e.keyCode == 65) {
            left = false;
        }
    }

    var count = 0;

    //adjust for html scaling
    ctx.translate(0.5,0.5);
    function update() {
        player.image.src = "../storage/png/Player.png";
        if (inventory.equipedItem != "none") {
            player.image.src = "../storage/png/player_empty.png";
        }

        ctx.clearRect(0,0,100000,100000);
        ctx.fillStyle="black";
        ctx.lineWidth = 1;
        player.draw(canvas.width/2-32,canvas.height/2-32);
        if (inventory.equipedItem instanceof Item) {
            ctx.drawImage(inventory.equipedItem.image,canvas.width/2-32+12,canvas.height/2-32+12,40,40);    
        }
        player.move(0.2,true);
        playerCollision.x = player.x;
        playerCollision.y = player.y;

        for (i=0;i<blocks.length;i++) {
            if (blocks[i].x*64-player.x+canvas.width/2 > canvas.width || blocks[i].x*64-player.x+canvas.width/2 < 0 || blocks[i].y*64-player.y+canvas.height/2 > canvas.height || blocks[i].y*64-player.y+canvas.height/2 < 0) {
            } else {
            blocks[i].draw(player.x-canvas.width/2+32,player.y-canvas.height/2+32);

            if (blocks[i].destroyed) {
                blocks.splice(i,1);
            }

            if (blocks[i].collision.checkCollision(playerCollision) == "top") {
                player.y = blocks[i].collision.y-64;
                player.dy = 0;
                player.onGround = true;
        }
            if (blocks[i].collision.checkCollision(playerCollision) == "bottom") {
                player.y = blocks[i].collision.y+blocks[i].collision.height;
                player.dy = 0;

        }
        if (blocks[i].collision.checkCollision(playerCollision) == "left") {
            player.x = blocks[i].collision.x-64;
            player.dx = 0;
        }
        if (blocks[i].collision.checkCollision(playerCollision) == "right") {
            player.x = blocks[i].collision.x+blocks[i].collision.width;
            player.dx = 0;
        }
    }
        }

        // movement
        if (right) {
            player.move(player.speed,false);  
        }
        if (left) {
            player.move(-player.speed,false)
        }

        inventory.draw();

        if (showCollision) {  
            for (i=0;i<blocks.length;i++) {
                if (blocks[i].x-player.x+canvas.width/2-32 > canvas.width || blocks[i].x-player.x+canvas.width/2-32 < 0 || blocks[i].y-player.y+canvas.height/2-32 > canvas.height || blocks[i].y-player.y+canvas.height/2-32 < 0) {
                    
                } else {
                blocks[i].collision.show(-player.x+canvas.width/2-32,-player.y+canvas.height/2-32,false);
                }
            }
        playerCollision.show(canvas.width/2-32,canvas.height/2-32,true);
        ctx.fillStyle = "black";
        ctx.fillText("x:" + parseInt(player.x) + " y:" + parseInt(player.y),5,20);
        ctx.fillText("dx: " + player.dx.toFixed(2) + " dy: " + player.dy.toFixed(2), 5,45);
        }
    }

    setInterval(update, 16);

/*
                if (collisions[i].x - playerCollision.x > 0 && playerCollision.x + playerCollision.width > collisions[i].x-1 && playerCollision.y+playerCollision.height-20 > collisions[i].y) {
                player.dx = 0;
                player.x = collisions[i].x-64;
            } else if ((collisions[i].x + collisions[i].width)- playerCollision.x < 0 && playerCollision.x < collisions[i].x+collisions[i].width+1 && playerCollision.y+playerCollision.height-20 > collisions[i].y) {
                player.dx = 0;
                player.x = collisions[i].x+collisions[i].width;
            } else if (collisions[i].y - playerCollision.y+playerCollision.height > 0) {
                player.dy = 0;
                player.y = collisions[i].y-64;
            } else if ((collisions[i].y+collisions[i].height) - playerCollision.y < 0) {
                player.dy = 0;
                player.y = collisions[i].y+collisions[i].height;
            }
            */

</script>
</html>